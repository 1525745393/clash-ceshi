name: Generate Clash Config

on:
  push:
    branches:
      - main
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *' # 每天凌晨自动运行一次

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Generate Final Clash Config
        shell: bash
        run: |
          python3 << 'EOF'
          import os
          import sys

          template_path = "yaml/clash-template.yaml"
          output_path = "yaml/clash-fallback-all.yaml"

          if not os.path.exists(template_path):
              print(f"[ERROR] Template file not found: {template_path}")
              sys.exit(1)

          with open(template_path, "r", encoding="utf-8") as f:
              content = f.read()

          # 仅保留的机场 Secrets
          secret_keys = [
              "MITCE_URL",
              "HKBEUP_URL",
          ]

          for key in secret_keys:
              value = os.environ.get(key)
              if not value:
                  print(f"[ERROR] Missing required secret: {key}")
                  sys.exit(1)

              placeholder = f"${{{{ secrets.{key} }}}}"
              content = content.replace(placeholder, value)

          with open(output_path, "w", encoding="utf-8") as f:
              f.write(content)

          print(f"[OK] Clash config generated: {output_path}")
          EOF
        env:
          MITCE_URL: ${{ secrets.MITCE_URL }}
          HKBEUP_URL: ${{ secrets.HKBEUP_URL }}

      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          if git diff --quiet; then
            echo "No changes detected, skip commit."
            exit 0
          fi

          git add yaml/clash-fallback-all.yaml
          git commit -m "Auto-generate final clash config [MITCE + HKBEUP] [skip ci]"
          git push origin main
